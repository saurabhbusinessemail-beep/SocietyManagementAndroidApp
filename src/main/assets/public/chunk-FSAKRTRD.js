import{d as ee}from"./chunk-BXTUOHYQ.js";import{a as re}from"./chunk-H5A3E2HY.js";import{B as le,E as ae,F as ce,a as te,e as oe,p as ne,y as se}from"./chunk-PWWNUZIU.js";import{A as I,E as J,L as K,M as Q,N as X,m as W,qa as Y,r as q,sa as Z,ta as ie,x as H}from"./chunk-KWNZ2CR7.js";import{Ab as v,C as V,Cb as c,Db as L,E as g,Eb as N,Ec as G,Fc as U,G as z,Jc as $,Lc as B,O as E,P as p,Sa as a,Ta as d,Ub as M,V as P,Vb as R,da as j,ea as k,f as b,hb as C,jb as l,ma as S,na as F,rb as f,sb as u,tb as x,ub as O,va as w,vb as D,xb as _}from"./chunk-WBOKHTJO.js";import{a as T,f as A}from"./chunk-CWTPBX7D.js";var de=["*"],ue=o=>({id:"",label:o}),me=()=>[];function he(o,m){if(o&1&&(O(0),x(1,"ui-label",11),D()),o&2){let e=m.$implicit,i=c(3);a(),l("config",R(2,ue,i.getFieldLabel(e)))("valueText",i.getFieldText(e))}}function Ce(o,m){if(o&1&&(f(0,"div",9),C(1,he,2,4,"ng-container",10),u()),o&2){let e=c(2);a(),l("ngForOf",e.getAllFields())}}function ge(o,m){if(o&1){let e=_();f(0,"app-icon",12),v("click",function(){S(e);let t=c(2);return F(t.isFilterOpen=!1)}),u()}}function Se(o,m){if(o&1){let e=_();f(0,"app-icon",13),v("click",function(){S(e);let t=c(2);return F(t.isFilterOpen=!0)}),u()}}function Fe(o,m){if(o&1&&(f(0,"div",5),C(1,Ce,2,1,"div",6)(2,ge,1,0,"app-icon",7)(3,Se,1,0,"app-icon",8),u()),o&2){let e=c();a(),l("ngIf",!e.isFilterOpen),a(),l("ngIf",e.isFilterOpen),a(),l("ngIf",!e.isFilterOpen)}}function _e(o,m){if(o&1){let e=_();f(0,"ui-select2",14),v("searchChange",function(t){S(e);let r=c();return F(r.onSocietySearch(t))}),u()}if(o&2){let e,i=c();l("formControl",i.societiesSearchConfig.formControl)("config",i.societiesSearchConfig)("options",(e=i.societiesSearchConfig.dropDownOptions)!==null&&e!==void 0?e:M(6,me))("smColumns",i.societyControlSizes[0])("mdColumns",i.societyControlSizes[1])("lgColumns",i.societyControlSizes[2])}}function ve(o,m){if(o&1&&x(0,"ui-select2",15),o&2){let e,i=c();l("formControl",i.flatSearchConfig.formControl)("config",i.flatSearchConfig)("options",(e=i.flatSearchConfig.dropDownOptions)!==null&&e!==void 0?e:M(6,me))("smColumns",i.societyControlSizes[0])("mdColumns",i.societyControlSizes[1])("lgColumns",i.societyControlSizes[2])}}function ye(o,m){o&1&&(O(0),N(1),D())}var Re=(()=>{class o{get allDropDownConfig(){return[this.societiesSearchConfig,this.flatSearchConfig,...this.dropDownControlConfigs]}constructor(e,i,t,r,s,n){this.fb=e,this.societyService=i,this.loginService=t,this.router=r,this.windowService=s,this.datePipe=n,this.societyControlSizes=[12,5,5],this.flatControlSizes=[12,5,5],this.loadFirstSociety=!1,this.dropDownControlConfigs=[],this.dateControlConfigs=[],this.isFlatMemberChanged=new w,this.filterChanged=new w,this.isFilterOpen=!1,this.societiesSearchConfig={id:"societyId",label:"Society",placeholder:"Search Society",formControl:new I(void 0),dropDownOptions:[]},this.flatSearchConfig={id:"flatId",label:"Flat",placeholder:"Search Flat",formControl:new I(void 0),dropDownOptions:[]},this.search$=new b,this.isComponentActive=new b}ngOnInit(){if(this.myProfile=this.loginService.getProfileFromStorage(),!this.myProfile){this.router.navigateByUrl("/");return}let e=[this.societiesSearchConfig,this.flatSearchConfig,...this.dropDownControlConfigs,...this.dateControlConfigs].reduce((i,t)=>(t.formControl&&(i[t.id]=t.formControl),i),{});this.filterFormGroup=this.fb.group(T({},e)),this.subscribeToFlatSelection(),this.subscribeToSocietySelection(this.myProfile),this.subscribeToOtherControlChanges(),this.myProfile.user.role==="admin"?this.subscribeToSocietySearch():this.loadMySocities(this.myProfile)}getAllFields(){let e=this.filterFormGroup?.value;return Object.keys(e??{})}getFieldLabel(e){return this.allDropDownConfig.find(i=>i.id===e)?.label??this.dateControlConfigs.find(i=>i.id===e)?.label}getFieldValue(e){let i=this.filterFormGroup?.value;if(this.allDropDownConfig.find(t=>t.id===e))return i[e]?.value;if(this.dateControlConfigs.find(t=>t.id===e))return i[e]}getFieldText(e){let i=this.filterFormGroup?.value;if(this.allDropDownConfig.find(t=>t.id===e))return i[e]?.label??"ALL";if(this.dateControlConfigs.find(t=>t.id===e))return this.datePipe.transform(i[e])}loadMySocities(e){this.societyService.getAllSocieties().pipe(g(1)).subscribe({next:i=>{let t=i.data;this.societiesSearchConfig.dropDownOptions=t.map(r=>({label:r.societyName,value:r._id})),t.length>0&&this.loadFirstSociety?this.societiesSearchConfig.formControl?.setValue({label:t[0].societyName,value:t[0]._id}):this.loadDefaultFlats(e)}})}amIAMember(e,i){let t=i??this.societiesSearchConfig.formControl?.value?.value,r=e.socities.filter(s=>!t||s.societyId===t).some(s=>s?.societyRoles?.some(n=>["owner","member","tenant"].includes(n.name)))??!1;this.isFlatMemberChanged.emit(r)}onSocietySearch(e){this.search$.next(e)}subscribeToOtherControlChanges(){this.dropDownControlConfigs.forEach(e=>{e.formControl&&e.formControl.valueChanges.pipe(p(this.isComponentActive)).subscribe(()=>this.emitSelectedFilter())}),this.dateControlConfigs.forEach(e=>{e.formControl&&e.formControl.valueChanges.pipe(p(this.isComponentActive)).subscribe(()=>this.emitSelectedFilter())})}subscribeToSocietySearch(){this.search$.pipe(V(100),z(),p(this.isComponentActive),E(e=>(this.societiesSearchConfig.dropDownOptions=[],this.societyService.searchSocieties(e).pipe(p(this.isComponentActive))))).subscribe({next:e=>{if(!e.success)return;let i=e.data;this.societiesSearchConfig.dropDownOptions=i.map(t=>({label:t.societyName,value:t._id}))}})}subscribeToSocietySelection(e){this.societiesSearchConfig.formControl?.valueChanges.pipe(p(this.isComponentActive)).subscribe(i=>{this.flatSearchConfig.formControl?.setValue(void 0,{emitEvent:!1});let t=e.user.role==="admin";if(this.myProfile&&this.amIAMember(this.myProfile),i){let r=e.socities.find(n=>n.societyId===i.value)?.societyRoles?.find(n=>["manager","societyadmin"].includes(n.name)),s=e.socities.find(n=>n.societyId===i.value)?.societyRoles?.find(n=>["owner","member","tenant"].includes(n.name));t||r?this.loadSocietyFlats(i.value):s&&this.loadAllMyFlats(i.value)}else this.loadDefaultFlats(e)})}loadDefaultFlats(e){return A(this,null,function*(){let i=e.user.role==="admin",t=e.socities.filter(n=>n.societyRoles.some(h=>["manager","societyadmin"].includes(h.name))),r=e.socities.some(n=>n.societyRoles.some(h=>["owner","member","tenant"].includes(h.name)));if(i){this.flatSearchConfig.dropDownOptions=[];return}let s=[];if(t.length>0){let n=t.map(y=>this.loadSocietyFlats(y.societyId,!1));(yield Promise.all(n)).forEach(y=>y.forEach(fe=>s.push(fe)))}r&&((yield this.loadAllMyFlats(void 0,!1)).forEach(h=>s.push(h)),this.flatSearchConfig.dropDownOptions=s),this.emitSelectedFilter()})}loadAllMyFlats(e,i=!0){return new Promise(t=>{this.societyService.myFlats(e).pipe(g(1)).subscribe(r=>{if(!r.success){t([]);return}let s=r.data.map(n=>this.societyService.convertFlatMemberToDropdownOption(n));i&&(this.flatSearchConfig.dropDownOptions=s,this.emitSelectedFilter()),t(s)})})}loadSocietyFlats(e,i=!0){return new Promise(t=>{this.societyService.getFlats(e).pipe(g(1)).subscribe(r=>{if(!r.success){t([]);return}let s=r.data.map(n=>this.societyService.convertFlatToDropdownOption(n,this.societiesSearchConfig.formControl?.value?.value));i&&(this.flatSearchConfig.dropDownOptions=s,this.emitSelectedFilter()),t(s)})})}subscribeToFlatSelection(){this.flatSearchConfig.formControl?.valueChanges.pipe(p(this.isComponentActive)).subscribe(e=>{this.emitSelectedFilter()})}emitSelectedFilter(){setTimeout(()=>{let e=this.filterFormGroup?.value;if(!e)return;let i=Object.keys(e).reduce((t,r)=>(t[r]=this.getFieldValue(r),t),{});this.filterChanged.emit(i)},100)}ngOnDestroy(){this.isComponentActive.next(),this.isComponentActive.complete()}static{this.\u0275fac=function(i){return new(i||o)(d(K),d(re),d(q),d(W),d(te),d($))}}static{this.\u0275cmp=j({type:o,selectors:[["app-filter"]],inputs:{societyControlSizes:"societyControlSizes",flatControlSizes:"flatControlSizes",loadFirstSociety:"loadFirstSociety",dropDownControlConfigs:"dropDownControlConfigs",dateControlConfigs:"dateControlConfigs"},outputs:{isFlatMemberChanged:"isFlatMemberChanged",filterChanged:"filterChanged"},ngContentSelectors:de,decls:6,vars:4,consts:[[1,"filter-container"],["class","flex flex-end",4,"ngIf"],["placeholder","Search Society",3,"formControl","config","options","smColumns","mdColumns","lgColumns","searchChange",4,"ngIf"],["placeholder","Search Flat",3,"formControl","config","options","smColumns","mdColumns","lgColumns",4,"ngIf"],[4,"ngIf"],[1,"flex","flex-end"],["class","flex-auto selected-filter-info",4,"ngIf"],["name","clear","size","md",3,"click",4,"ngIf"],["name","filter","size","md",3,"click",4,"ngIf"],[1,"flex-auto","selected-filter-info"],[4,"ngFor","ngForOf"],[3,"config","valueText"],["name","clear","size","md",3,"click"],["name","filter","size","md",3,"click"],["placeholder","Search Society",3,"searchChange","formControl","config","options","smColumns","mdColumns","lgColumns"],["placeholder","Search Flat",3,"formControl","config","options","smColumns","mdColumns","lgColumns"]],template:function(i,t){i&1&&(L(),f(0,"div",0),C(1,Fe,4,3,"div",1),f(2,"ui-form-layout"),C(3,_e,1,7,"ui-select2",2)(4,ve,1,7,"ui-select2",3)(5,ye,2,0,"ng-container",4),u()()),i&2&&(a(),l("ngIf",t.windowService.mode.value==="mobile"),a(2),l("ngIf",t.societiesSearchConfig.formControl&&(t.windowService.mode.value!=="mobile"||t.isFilterOpen)),a(),l("ngIf",t.flatSearchConfig.formControl&&(t.windowService.mode.value!=="mobile"||t.isFilterOpen)),a(),l("ngIf",t.windowService.mode.value!=="mobile"||t.isFilterOpen))},dependencies:[G,U,H,J,ne,Y,se,oe,Z],styles:[".filter-container[_ngcontent-%COMP%]{padding:12px;background-color:#f1f1f1;border-radius:14px;border:solid 1px #d0d7df;margin-bottom:16px}.filter-container[_ngcontent-%COMP%]   .selected-filter-info[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,1fr)!important;row-gap:8px}.filter-container[_ngcontent-%COMP%]   .selected-filter-info[_ngcontent-%COMP%]     label{border-left:solid 1px #7ec8ff;padding-left:5px}"]})}}return o})();var Ye=(()=>{class o{static{this.\u0275fac=function(i){return new(i||o)}}static{this.\u0275mod=k({type:o})}static{this.\u0275inj=P({imports:[B,X,Q,le,ae,ce,ie,ee]})}}return o})();export{Re as a,Ye as b};
