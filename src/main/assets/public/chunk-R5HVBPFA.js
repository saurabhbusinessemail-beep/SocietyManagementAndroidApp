import{d as ee}from"./chunk-BXTUOHYQ.js";import{a as re}from"./chunk-H5A3E2HY.js";import{B as le,E as ae,F as ce,a as ie,e as oe,p as ne,y as se}from"./chunk-PWWNUZIU.js";import{A as I,E as J,L as K,M as Q,N as X,m as W,qa as Y,r as q,sa as Z,ta as te,x as H}from"./chunk-KWNZ2CR7.js";import{Ab as v,C as P,Cb as c,Db as L,E as g,Eb as N,Ec as G,Fc as U,G as V,Jc as $,Lc as B,O as z,P as p,Sa as a,Ta as d,Ub as M,V as E,Vb as R,da as j,ea as k,f as b,hb as h,jb as l,ma as S,na as F,rb as f,sb as u,tb as x,ub as O,va as w,vb as D,xb as _}from"./chunk-WBOKHTJO.js";import{a as T,f as A}from"./chunk-CWTPBX7D.js";var de=["*"],ue=o=>({id:"",label:o}),me=()=>[];function Ce(o,m){if(o&1&&(O(0),x(1,"ui-label",11),D()),o&2){let e=m.$implicit,t=c(3);a(),l("config",R(2,ue,t.getFieldLabel(e)))("valueText",t.getFieldText(e))}}function he(o,m){if(o&1&&(f(0,"div",9),h(1,Ce,2,4,"ng-container",10),u()),o&2){let e=c(2);a(),l("ngForOf",e.getAllFields())}}function ge(o,m){if(o&1){let e=_();f(0,"app-icon",12),v("click",function(){S(e);let i=c(2);return F(i.isFilterOpen=!1)}),u()}}function Se(o,m){if(o&1){let e=_();f(0,"app-icon",13),v("click",function(){S(e);let i=c(2);return F(i.isFilterOpen=!0)}),u()}}function Fe(o,m){if(o&1&&(f(0,"div",5),h(1,he,2,1,"div",6)(2,ge,1,0,"app-icon",7)(3,Se,1,0,"app-icon",8),u()),o&2){let e=c();a(),l("ngIf",!e.isFilterOpen),a(),l("ngIf",e.isFilterOpen),a(),l("ngIf",!e.isFilterOpen)}}function _e(o,m){if(o&1){let e=_();f(0,"ui-select2",14),v("searchChange",function(i){S(e);let r=c();return F(r.onSocietySearch(i))}),u()}if(o&2){let e,t=c();l("formControl",t.societiesSearchConfig.formControl)("config",t.societiesSearchConfig)("options",(e=t.societiesSearchConfig.dropDownOptions)!==null&&e!==void 0?e:M(6,me))("smColumns",t.societyControlSizes[0])("mdColumns",t.societyControlSizes[1])("lgColumns",t.societyControlSizes[2])}}function ve(o,m){if(o&1&&x(0,"ui-select2",15),o&2){let e,t=c();l("formControl",t.flatSearchConfig.formControl)("config",t.flatSearchConfig)("options",(e=t.flatSearchConfig.dropDownOptions)!==null&&e!==void 0?e:M(6,me))("smColumns",t.societyControlSizes[0])("mdColumns",t.societyControlSizes[1])("lgColumns",t.societyControlSizes[2])}}function ye(o,m){o&1&&(O(0),N(1),D())}var Re=(()=>{class o{get allDropDownConfig(){return[this.societiesSearchConfig,this.flatSearchConfig,...this.dropDownControlConfigs]}constructor(e,t,i,r,s,n){this.fb=e,this.societyService=t,this.loginService=i,this.router=r,this.windowService=s,this.datePipe=n,this.societyControlSizes=[12,5,5],this.flatControlSizes=[12,5,5],this.loadFirstSociety=!1,this.dropDownControlConfigs=[],this.dateControlConfigs=[],this.isFlatMemberChanged=new w,this.filterChanged=new w,this.isFilterOpen=!1,this.societiesSearchConfig={id:"societyId",label:"Society",placeholder:"Search Society",formControl:new I(void 0),dropDownOptions:[]},this.flatSearchConfig={id:"flatId",label:"Flat",placeholder:"Search Flat",formControl:new I(void 0),dropDownOptions:[]},this.search$=new b,this.isComponentActive=new b}ngOnInit(){if(this.myProfile=this.loginService.getProfileFromStorage(),!this.myProfile){this.router.navigateByUrl("/");return}let e=[this.societiesSearchConfig,this.flatSearchConfig,...this.dropDownControlConfigs,...this.dateControlConfigs].reduce((t,i)=>(i.formControl&&(t[i.id]=i.formControl),t),{});this.filterFormGroup=this.fb.group(T({},e)),this.subscribeToFlatSelection(),this.subscribeToSocietySelection(this.myProfile),this.subscribeToOtherControlChanges(),this.myProfile.user.role==="admin"?this.subscribeToSocietySearch():this.loadMySocities(this.myProfile)}getAllFields(){let e=this.filterFormGroup?.value;return Object.keys(e??{})}getFieldLabel(e){return this.allDropDownConfig.find(t=>t.id===e)?.label??this.dateControlConfigs.find(t=>t.id===e)?.label}getFieldValue(e){let t=this.filterFormGroup?.value;if(this.allDropDownConfig.find(i=>i.id===e))return t[e]?.value;if(this.dateControlConfigs.find(i=>i.id===e))return t[e]}getFieldText(e){let t=this.filterFormGroup?.value;if(this.allDropDownConfig.find(i=>i.id===e))return t[e]?.label??"ALL";if(this.dateControlConfigs.find(i=>i.id===e))return this.datePipe.transform(t[e])}loadMySocities(e){this.societyService.getAllSocieties().pipe(g(1)).subscribe({next:t=>{let i=t.data;this.societiesSearchConfig.dropDownOptions=i.map(r=>({label:r.societyName,value:r._id})),i.length>0&&this.loadFirstSociety?this.societiesSearchConfig.formControl?.setValue({label:i[0].societyName,value:i[0]._id}):this.loadDefaultFlats(e)}})}amIAMember(e,t){let i=t??this.societiesSearchConfig.formControl?.value?.value,r=e.socities.filter(s=>!i||s.societyId===i).some(s=>s?.societyRoles?.some(n=>["owner","member","tenant"].includes(n.name)))??!1;this.isFlatMemberChanged.emit(r)}onSocietySearch(e){this.search$.next(e)}subscribeToOtherControlChanges(){this.dropDownControlConfigs.forEach(e=>{e.formControl&&e.formControl.valueChanges.pipe(p(this.isComponentActive)).subscribe(()=>this.emitSelectedFilter())}),this.dateControlConfigs.forEach(e=>{e.formControl&&e.formControl.valueChanges.pipe(p(this.isComponentActive)).subscribe(()=>this.emitSelectedFilter())})}subscribeToSocietySearch(){this.search$.pipe(P(100),V(),p(this.isComponentActive),z(e=>(this.societiesSearchConfig.dropDownOptions=[],this.societyService.searchSocieties(e).pipe(p(this.isComponentActive))))).subscribe({next:e=>{if(!e.success)return;let t=e.data;this.societiesSearchConfig.dropDownOptions=t.map(i=>({label:i.societyName,value:i._id}))}})}subscribeToSocietySelection(e){this.societiesSearchConfig.formControl?.valueChanges.pipe(p(this.isComponentActive)).subscribe(t=>{this.flatSearchConfig.formControl?.setValue(void 0,{emitEvent:!1});let i=e.user.role==="admin";if(this.myProfile&&this.amIAMember(this.myProfile),t){let r=e.socities.find(n=>n.societyId===t.value)?.societyRoles?.find(n=>["manager","societyadmin"].includes(n.name)),s=e.socities.find(n=>n.societyId===t.value)?.societyRoles?.find(n=>["owner","member","tenant"].includes(n.name));i||r?this.loadSocietyFlats(t.value):s&&this.loadAllMyFlats(t.value)}else this.loadDefaultFlats(e)})}loadDefaultFlats(e){return A(this,null,function*(){let t=e.user.role==="admin",i=e.socities.filter(n=>n.societyRoles.some(C=>["manager","societyadmin"].includes(C.name))),r=e.socities.some(n=>n.societyRoles.some(C=>["owner","member","tenant"].includes(C.name)));if(t){this.flatSearchConfig.dropDownOptions=[];return}let s=[];if(i.length>0){let n=i.map(y=>this.loadSocietyFlats(y.societyId,!1));(yield Promise.all(n)).forEach(y=>y.forEach(fe=>s.push(fe)))}r&&((yield this.loadAllMyFlats(void 0,!1)).forEach(C=>s.push(C)),this.flatSearchConfig.dropDownOptions=s),this.emitSelectedFilter()})}loadAllMyFlats(e,t=!0){return new Promise(i=>{this.societyService.myFlats(e).pipe(g(1)).subscribe(r=>{if(!r.success){i([]);return}let s=r.data.map(n=>this.societyService.convertFlatMemberToDropdownOption(n));t&&(this.flatSearchConfig.dropDownOptions=s,this.emitSelectedFilter()),i(s)})})}loadSocietyFlats(e,t=!0){return new Promise(i=>{this.societyService.getFlats(e).pipe(g(1)).subscribe(r=>{if(!r.success){i([]);return}let s=r.data.map(n=>this.societyService.convertFlatToDropdownOption(n,this.societiesSearchConfig.formControl?.value?.value));t&&(this.flatSearchConfig.dropDownOptions=s,this.emitSelectedFilter()),i(s)})})}subscribeToFlatSelection(){this.flatSearchConfig.formControl?.valueChanges.pipe(p(this.isComponentActive)).subscribe(e=>{this.emitSelectedFilter()})}emitSelectedFilter(){setTimeout(()=>{let e=this.filterFormGroup?.value;if(!e)return;let t=Object.keys(e).reduce((i,r)=>(i[r]=this.getFieldValue(r),i),{});this.filterChanged.emit(t)},100)}ngOnDestroy(){this.isComponentActive.next(),this.isComponentActive.complete()}static{this.\u0275fac=function(t){return new(t||o)(d(K),d(re),d(q),d(W),d(ie),d($))}}static{this.\u0275cmp=j({type:o,selectors:[["app-filter"]],inputs:{societyControlSizes:"societyControlSizes",flatControlSizes:"flatControlSizes",loadFirstSociety:"loadFirstSociety",dropDownControlConfigs:"dropDownControlConfigs",dateControlConfigs:"dateControlConfigs"},outputs:{isFlatMemberChanged:"isFlatMemberChanged",filterChanged:"filterChanged"},ngContentSelectors:de,decls:6,vars:4,consts:[[1,"filter-container"],["class","flex flex-end",4,"ngIf"],["placeholder","Search Society",3,"formControl","config","options","smColumns","mdColumns","lgColumns","searchChange",4,"ngIf"],["placeholder","Search Flat",3,"formControl","config","options","smColumns","mdColumns","lgColumns",4,"ngIf"],[4,"ngIf"],[1,"flex","flex-end"],["class","flex-auto selected-filter-info",4,"ngIf"],["name","clear","size","md",3,"click",4,"ngIf"],["name","filter","size","md",3,"click",4,"ngIf"],[1,"flex-auto","selected-filter-info"],[4,"ngFor","ngForOf"],[3,"config","valueText"],["name","clear","size","md",3,"click"],["name","filter","size","md",3,"click"],["placeholder","Search Society",3,"searchChange","formControl","config","options","smColumns","mdColumns","lgColumns"],["placeholder","Search Flat",3,"formControl","config","options","smColumns","mdColumns","lgColumns"]],template:function(t,i){t&1&&(L(),f(0,"div",0),h(1,Fe,4,3,"div",1),f(2,"ui-form-layout"),h(3,_e,1,7,"ui-select2",2)(4,ve,1,7,"ui-select2",3)(5,ye,2,0,"ng-container",4),u()()),t&2&&(a(),l("ngIf",i.windowService.mode.value==="mobile"),a(2),l("ngIf",i.societiesSearchConfig.formControl&&(i.windowService.mode.value!=="mobile"||i.isFilterOpen)),a(),l("ngIf",i.flatSearchConfig.formControl&&(i.windowService.mode.value!=="mobile"||i.isFilterOpen)),a(),l("ngIf",i.windowService.mode.value!=="mobile"||i.isFilterOpen))},dependencies:[G,U,H,J,ne,Y,se,oe,Z],styles:[".filter-container[_ngcontent-%COMP%]{padding:12px;background-color:#f1f1f1;border-radius:14px;border:solid 1px #d0d7df;margin-bottom:16px}.filter-container[_ngcontent-%COMP%]   .selected-filter-info[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,1fr)!important;row-gap:8px}.filter-container[_ngcontent-%COMP%]   .selected-filter-info[_ngcontent-%COMP%]     ui-label{white-space:nowrap}.filter-container[_ngcontent-%COMP%]   .selected-filter-info[_ngcontent-%COMP%]     label{border-left:solid 1px #7ec8ff;padding-left:5px}"]})}}return o})();var Ye=(()=>{class o{static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275mod=k({type:o})}static{this.\u0275inj=E({imports:[B,X,Q,le,ae,ce,te,ee]})}}return o})();export{Re as a,Ye as b};
